#!/bin/bash
# =============================================================================
# 日次実行スクリプト（Mac用）
# =============================================================================
#
# 機能:
#   - 最新の株価データを取得（最小限のみ）
#   - スコアリングを実行
#   - 推奨銘柄を出力
#   - 古いキャッシュを自動削除
#
# =============================================================================

set -e

# Script directory
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$SCRIPT_DIR"

# Load environment
if [ -f "$SCRIPT_DIR/.env" ]; then
    export $(grep -v '^#' "$SCRIPT_DIR/.env" | xargs)
fi

# Activate virtual environment
source "$SCRIPT_DIR/.venv/bin/activate"

# Timestamp
TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")
echo "========================================"
echo "日次推奨システム実行"
echo "実行時刻: $TIMESTAMP"
echo "========================================"

# =============================================================================
# 1. Clean old cache (keep only 3 days) - ローカルデータ最小化
# =============================================================================
echo "[1/3] 古いキャッシュを削除中..."
find "$SCRIPT_DIR/data/cache" -type f -mtime +3 -delete 2>/dev/null || true
echo "  ✓ 3日以上前のキャッシュを削除しました"

# =============================================================================
# 2. Run daily recommendation
# =============================================================================
echo "[2/3] 推奨銘柄を計算中..."
python3 "$SCRIPT_DIR/scripts/run_daily_recommendation.py" 2>&1

# =============================================================================
# 3. Output summary
# =============================================================================
echo "[3/3] 完了"
echo ""
echo "========================================"
echo "実行完了: $(date +"%Y-%m-%d %H:%M:%S")"
echo "========================================"

# Deactivate
deactivate
